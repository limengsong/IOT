(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-d386c6de"],{"1aa4":function(e,t,a){"use strict";var s=a("e719"),i=a.n(s);i.a},ce8e:function(e,t,a){"use strict";a.r(t);var s=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"content"},[a("left-right-bottom",{scopedSlots:e._u([{key:"topLeft",fn:function(){return[a("Card",{staticStyle:{height:"100%"},attrs:{title:"电子称列表"}},[a("ButtonGroup",[a("i-button",{attrs:{icon:"md-refresh"},on:{click:e.refresh}}),a("i-button",{attrs:{icon:"md-add-circle",disabled:e.testDis},on:{click:e.register}})],1),a("i-switch",{attrs:{disabled:e.testDis},on:{"on-change":e.testOpen},model:{value:e.testStatus,callback:function(t){e.testStatus=t},expression:"testStatus"}}),a("Table",{ref:"currentRowTable",attrs:{"highlight-row":"",columns:e.scaleColumns,data:e.scaleData},on:{"on-row-click":e.onClick}})],1)]},proxy:!0},{key:"topRight",fn:function(){return[a("Card",{staticStyle:{height:"100%"},attrs:{title:"详细信息"}},[a("p",{staticStyle:{"font-weight":"bold"}},[e._v("设备品牌： "+e._s(e.selectRow.cfgBrand)+" ")]),a("p",{staticStyle:{"font-weight":"bold"}},[e._v("配置名称： "+e._s(e.selectRow.cfgName))]),a("p",{staticStyle:{"font-weight":"bold"}},[e._v("接口方式： "+e._s(e.selectRow.cfgType)+" ")]),e.seenTcp?a("p",{staticStyle:{"font-weight":"bold"}},[e._v("设备IP："+e._s(e.selectRow.cfgIp)+" ")]):e._e(),e.seenTcp?a("p",{staticStyle:{"font-weight":"bold"}},[e._v("设备端口号："+e._s(e.selectRow.cfgPort))]):e._e(),e.seenSerial?a("p",{staticStyle:{"font-weight":"bold"}},[e._v("设备串口号："+e._s(e.selectRow.cfgSerialPort)+" ")]):e._e(),e.seenSerial?a("p",{staticStyle:{"font-weight":"bold"}},[e._v("设备波特率："+e._s(e.selectRow.cfgBaudRate))]):e._e(),e.seenSerial?a("p",{staticStyle:{"font-weight":"bold"}},[e._v("设备数据位："+e._s(e.selectRow.cfgDataBits)+" ")]):e._e(),e.seenSerial?a("p",{staticStyle:{"font-weight":"bold"}},[e._v("设备停止位："+e._s(e.selectRow.cfgStopBits))]):e._e(),e.seenSerial?a("p",{staticStyle:{"font-weight":"bold"}},[e._v("设备校验位"+e._s(e.selectRow.cfgParity)+" ")]):e._e()])]},proxy:!0},{key:"bottom",fn:function(){return[a("Card",{style:e.logStyle},[a("p",{attrs:{slot:"title"},slot:"title"},[e._v(" 调试日志 ")]),a("p",{attrs:{slot:"extra"},slot:"extra"},[a("Button",{attrs:{icon:"ios-trash"},on:{click:e.trash}},[e._v("清空")])],1),e._l(e.logList,(function(t,s){return a("div",{key:s,style:{color:e.getColors(t)}},[e._v(" "+e._s(t)+" ")])}))],2)]},proxy:!0}])}),a("Modal",{attrs:{title:"注册"},model:{value:e.modalVisible,callback:function(t){e.modalVisible=t},expression:"modalVisible"}},[a("Form",{ref:"deviceItem",attrs:{model:e.deviceItem,rules:e.ruleDevice,"label-width":80}},[a("FormItem",{attrs:{label:"编码",prop:"code"}},[a("Input",{attrs:{placeholder:"请输入设备编码"},model:{value:e.deviceItem.code,callback:function(t){e.$set(e.deviceItem,"code",t)},expression:"deviceItem.code"}})],1),a("FormItem",{attrs:{label:"名称"}},[a("Input",{attrs:{disabled:"disabled",placeholder:"请输入设备名称"},model:{value:e.deviceItem.name,callback:function(t){e.$set(e.deviceItem,"name",t)},expression:"deviceItem.name"}})],1),a("FormItem",{attrs:{label:"类型"}},[a("Input",{attrs:{disabled:"disabled"},model:{value:e.deviceItem.type,callback:function(t){e.$set(e.deviceItem,"type",t)},expression:"deviceItem.type"}})],1),a("FormItem",{attrs:{label:"通信地址",prop:"wsAddress"}},[a("Select",{model:{value:e.deviceItem.wsAddress,callback:function(t){e.$set(e.deviceItem,"wsAddress",t)},expression:"deviceItem.wsAddress"}},e._l(e.scaleWsUrl,(function(t){return a("Option",{key:t.value,attrs:{value:t.text}},[e._v(" "+e._s(t.text)+" ")])})),1)],1),a("FormItem",{attrs:{label:"工作站"}},[a("Select",{model:{value:e.deviceItem.wkStation,callback:function(t){e.$set(e.deviceItem,"wkStation",t)},expression:"deviceItem.wkStation"}},e._l(e.allWks,(function(t){return a("Option",{key:t.code,attrs:{value:t.code}},[e._v(" "+e._s(t.name)+" ")])})),1)],1)],1),a("div",{attrs:{slot:"footer"},slot:"footer"},[a("Button",{attrs:{type:"text"},on:{click:function(t){return e.cancel("deviceItem")}}},[e._v("取消")]),a("Button",{directives:[{name:"click-time",rawName:"v-click-time"}],attrs:{type:"primary"},on:{click:function(t){return e.ok("deviceItem")}}},[e._v("确定")])],1)],1)],1)},i=[],n=(a("a4d3"),a("e01a"),a("d28b"),a("99af"),a("b0c0"),a("d3b7"),a("4d63"),a("ac1f"),a("25f0"),a("3ca3"),a("5319"),a("ddb0"),a("96cf"),a("1da1")),r=a("23f4"),l=a("c6e7"),o=a("f121"),c={name:"LeftRightBottomDemo",components:{leftRightBottom:r["a"]},mixins:[l["a"]],data:function(){var e=this,t=function(t,a,s){if(!a)return s(new Error("code:".concat(a,"不能为空!")));var i='query($code:String!) {\n                                    db_exists(\n                                        type:"Device"\n                                        where:{\n                                        id_not:null\n                                        code: $code\n                                        }\n                                    )\n                                    }',n={query:i,variables:{code:a}};e.$ajax.post("webs/check",null,n).then((function(e){console.log("res.data.db_exists",e.data.db_exists),e.data.db_exists?s(new Error("code:".concat(a,"已经存在！"))):s()}))};return{testStatus:!1,modalVisible:!1,logStyle:{height:"100%"},localIpAdds:[],scaleWsUrl:[],allWks:[],testDis:!0,seenTcp:!1,seenSerial:!1,selectRow:{},scaleWS:{},scaleColumns:[{type:"index",width:60,align:"center"},{title:"Name",key:"name"},{title:"Address",key:"wsPath"}],scaleData:[],logList:[],wkcInfo:[],deviceItem:{code:"",name:"",type:"",wsAddress:"",wkStation:""},ruleDevice:{code:[{validator:t,trigger:"blur"}],wsAddress:[{required:!0,message:"请选择设备通信地址"}]}}},methods:{cancel:function(e){this.modalVisible=!1,this.$refs[e].resetFields()},ok:function(e){var t=this;this.$refs[e].validate(function(){var a=Object(n["a"])(regeneratorRuntime.mark((function a(s){var i,n,r;return regeneratorRuntime.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(!s){a.next=16;break}return i={},i.code=t.$refs[e].model.code,i.name=t.$refs[e].model.name,i.deviceType=t.$refs[e].model.type,i.address=t.$refs[e].model.wsAddress,i.status="REGISTER",i.workStation={connect:{code:t.$refs[e].model.wkStation}},n="\n                            mutation ($create: DeviceCreateInput!){\n                            createDevice(\n                                data:$create\n                            )\n                            {\n                                id\n                                name\n                            }\n                            }\n                         ",{query:n,variables:{create:i}},a.next=12,t.regDevice(i);case 12:r=a.sent,r&&(t.$Message.success("创建设备".concat(r,"成功！")),t.modalVisible=!1),a.next=17;break;case 16:t.$Message.error("校验设备信息失败！");case 17:case"end":return a.stop()}}),a)})));return function(e){return a.apply(this,arguments)}}())},checkTarAdds:function(e){return""!==e&&void 0!==e&&!(!this.isValidIP(e)&&!this.isValidUrl(e))},isValidIP:function(e){var t=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;return t.test(e)},isValidUrl:function(e){var t=/^(?=^.{3,255}$)[a-zA-Z0-9][-a-zA-Z0-9]{0,62}(\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+$/,a=new RegExp(t);return!!a.test(e)},testOpen:function(e){var t=this;if("{}"===JSON.stringify(this.selectRow))this.makeLog("未选中任何电子称"),this.testStatus=!1;else if(e){var a=o["a"].baseUrl.pro;a=a+"api"+this.selectRow.wsPath,a=a.replace(/http/g,"ws"),console.log("addUrl",a),this.scaleWS=new WebSocket(a),this.scaleWS.onopen=function(){},this.scaleWS.onmessage=function(e){var a=e.data;t.makeLog(a)},this.scaleWS.onclose=function(){}}else this.scaleWS.close()},onClick:function(e,t){this.selectRow=e,this.selectRow.level=2,"tcpip"===this.selectRow.cfgType?(this.seenTcp=!0,this.seenSerial=!1):(this.seenTcp=!1,this.seenSerial=!0),this.testDis=!1},getColors:function(e){return 1===e.level?"black":2===e.level?"#CD4F39":3===e.level?"#CD2626":void 0},getDate:function(){var e=new Date,t=e.getFullYear(),a=e.getMonth()+1,s=e.getDate(),i=e.getHours(),n=e.getMinutes(),r=e.getSeconds();e.getSeconds();n=n>9?n:"0"+n,i>5&&i<12?i="上午"+i:i>11&&i<18?(i-=12,i="下午"+i):i>17&&i<24?(i-=12,i="晚上"+i):i="凌晨"+i,r=r>9?r:"0"+r;var l=t+"年"+a+"月"+s+"日   "+i+":"+n+":"+r;return l},makeLog:function(e){var t=this.getDate(),a="".concat(t,":")+"   "+"".concat(e);this.logList.unshift(a),this.logList.length>10&&(this.logStyle={})},trash:function(){this.logList=[],this.logStyle={height:"100%"}},refresh:function(){this.makeLog("从组态信息中导入数据"),this.scaleData=[],this.getScaleList(),this.testDis=!0},register:function(){if("{}"===JSON.stringify(this.selectRow))this.makeLog("未选中任何电子称"),this.testStatus=!1;else{this.$refs["deviceItem"].resetFields(),this.scaleWsUrl=[],this.deviceItem.name=this.selectRow.name,this.deviceItem.type="scale-config"===this.selectRow.type?"WEIGH":"Unkown";var e=this.selectRow.wsPath;if(this.localIpAdds.length>0){var t=!0,a=!1,s=void 0;try{for(var i,n=this.localIpAdds[Symbol.iterator]();!(t=(i=n.next()).done);t=!0){var r=i.value,l={};l.value="ws://".concat(r,":3000/api").concat(e),l.text="ws://".concat(r,":3000/api").concat(e),this.scaleWsUrl.push(l)}}catch(o){a=!0,s=o}finally{try{t||null==n.return||n.return()}finally{if(a)throw s}}}this.modalVisible=!0}},getScaleList:function(){var e=this;this.$ajax.get("/red/flows").then((function(t){e.scaleData=e.getScaleWSInfo(t),console.log("this.scaleData ",e.scaleData)}))},deepClone:function(e){var t=JSON.stringify(e),a=JSON.parse(t);return a},dealScaleCfg:function(e){var t=[];if(e&&e.length>0){var a=!0,s=!1,i=void 0;try{for(var n,r=e[Symbol.iterator]();!(a=(n=r.next()).done);a=!0){var l=n.value;"scale-config"===l.type&&t.push(l)}}catch(o){s=!0,i=o}finally{try{a||null==r.return||r.return()}finally{if(s)throw i}}}return t},getScaleInfo:function(e){var t=this.deepClone(this.dealScaleCfg(e));if(e&&e.length>0){var a=!0,s=!1,i=void 0;try{for(var n,r=e[Symbol.iterator]();!(a=(n=r.next()).done);a=!0){var l=n.value,o=!0,c=!1,d=void 0;try{for(var u,f=t[Symbol.iterator]();!(o=(u=f.next()).done);o=!0){var h=u.value;h.devcfg===l.id&&(h.cfgName=l.name,h.cfgBrand=l.brand,h.cfgType=l.devtype,"tcpip"===h.cfgType?(h.cfgIp=l.ip,h.cfgPort=l.port):(h.cfgSerialPort=l.serialPort,h.cfgBaudRate=l.baudRate,h.cfgDataBits=l.dataBits,h.cfgStopBits=l.stopBits,h.cfgParity=l.parity))}}catch(v){c=!0,d=v}finally{try{o||null==f.return||f.return()}finally{if(c)throw d}}}}catch(v){s=!0,i=v}finally{try{a||null==r.return||r.return()}finally{if(s)throw i}}}return t},getScaleWS:function(e){var t=this.deepClone(this.getScaleInfo(e));if(e&&e.length>0){var a=!0,s=!1,i=void 0;try{for(var n,r=e[Symbol.iterator]();!(a=(n=r.next()).done);a=!0){var l=n.value;if(l.wires&&l.wires[0]&&l.wires[0][0]){var o=!0,c=!1,d=void 0;try{for(var u,f=t[Symbol.iterator]();!(o=(u=f.next()).done);o=!0){var h=u.value;h.id===l.wires[0][0]&&(h.server=l.server)}}catch(v){c=!0,d=v}finally{try{o||null==f.return||f.return()}finally{if(c)throw d}}}}}catch(v){s=!0,i=v}finally{try{a||null==r.return||r.return()}finally{if(s)throw i}}}return t},getScaleWSInfo:function(e){var t=this.deepClone(this.getScaleWS(e));if(e&&e.length>0){var a=!0,s=!1,i=void 0;try{for(var n,r=e[Symbol.iterator]();!(a=(n=r.next()).done);a=!0){var l=n.value,o=!0,c=!1,d=void 0;try{for(var u,f=t[Symbol.iterator]();!(o=(u=f.next()).done);o=!0){var h=u.value;h.server===l.id&&(h.wsPath=l.path)}}catch(v){c=!0,d=v}finally{try{o||null==f.return||f.return()}finally{if(c)throw d}}}}catch(v){s=!0,i=v}finally{try{a||null==r.return||r.return()}finally{if(s)throw i}}}return t}},mounted:function(){var e=this;this.$nextTick(Object(n["a"])(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return e.getScaleList(),t.next=3,e.getLocalIP();case 3:return e.localIpAdds=t.sent,t.next=6,e.getAllWks();case 6:e.allWks=t.sent;case 7:case"end":return t.stop()}}),t)}))))},computed:{},watch:{}},d=c,u=(a("1aa4"),a("2877")),f=Object(u["a"])(d,s,i,!1,null,"4d8de407",null);t["default"]=f.exports},e719:function(e,t,a){}}]);